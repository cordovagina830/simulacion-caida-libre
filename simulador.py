# -*- coding: utf-8 -*-
"""simulacion.caida)_libre

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1_PdocM8dcyhKTCcjxTdweWcF1HenEguS
"""

# Commented out IPython magic to ensure Python compatibility.
# -----------------------------
# SimulaciÃ³n completa: CaÃ­da libre (correcciÃ³n para slider y fÃ³rmula)
# -----------------------------

import numpy as np
import matplotlib.pyplot as plt
import matplotlib.patches as patches
from IPython.display import display, clear_output, HTML
import ipywidgets as widgets
import math

# Mostrar figuras dentro del notebook
# %matplotlib inline

# ------------------------------------------------
# Constante
g = 9.8  # m/s^2
# ------------------------------------------------

# -------------------------
# FunciÃ³n para formatear a 2 decimales sin redondear
# -------------------------
def trunc2(x):
    return math.floor(x * 100) / 100

# -------------------------
# Funciones de escena/actualizaciÃ³n
# -------------------------
def create_scene(h0):
    """Crea figura con regla vertical y texto de fase dentro del grÃ¡fico."""
    fig, ax = plt.subplots(figsize=(4, 6))
    ax.set_xlim(-1.0, 0.6)
    ax.set_ylim(0, max(1.0, h0 * 1.2))
    ax.axis('off')

    # Suelo
    ax.hlines(0, -0.5, 0.5, color='saddlebrown', linewidth=6, zorder=1)

    # Regla vertical
    xruler = -0.85
    ax.vlines(xruler, 0, h0 if h0 > 0 else 1.0, color='black', linewidth=2, zorder=2)
    tick_len = 0.04
    for h in np.arange(0, max(h0, 1) + 1, 1):
        ax.hlines(h, xruler, xruler + tick_len, color='black', linewidth=1, zorder=3)
        ax.text(xruler - 0.04, h, f"{int(h)} m", fontsize=8, va='center', ha='right', color='black')

    # TamaÃ±o visual del objeto
    radius = max(0.12, min(0.25, h0 * 0.03))

    # Objeto (pelota)
    circle = patches.Circle((0, h0), radius, color='dodgerblue', ec='navy', zorder=5)
    ax.add_patch(circle)

    # Flecha de velocidad
    arrow = patches.FancyArrowPatch((0, h0 - radius - 0.05), (0, h0 - radius - 0.35),
                                    arrowstyle='->', mutation_scale=20, color='orange', linewidth=3, zorder=6)
    ax.add_patch(arrow)

    # Textos dinÃ¡micos
    t_text = ax.text(-0.9, max(1.0, h0 * 1.2) * 0.9, "", fontsize=11, color='black')
    v_text = ax.text(-0.9, max(1.0, h0 * 1.2) * 0.85, "", fontsize=11, color='orange')
    y_text = ax.text(-0.9, max(1.0, h0 * 1.2) * 0.8, "", fontsize=11, color='green')
    phase_text = ax.text(0.0, max(1.0, h0 * 1.2) * 0.95, "", fontsize=11, ha='center', va='bottom', color='blue')

    # Tiempo estimado de caÃ­da
    t_end = np.sqrt(2 * h0 / g) if h0 > 0 else 0.0

    # Cerrar la figura para evitar que se muestre automÃ¡ticamente
    plt.close(fig)

    return fig, ax, circle, arrow, t_text, v_text, y_text, radius, phase_text, t_end

def update_scene(frame_idx, fig, ax, circle, arrow, t_text, v_text, y_text, radius, phase_text, h0, show_formulas, frames=200):
    """Actualiza la figura y construye HTML con fÃ³rmulas (valores truncados a 2 decimales sin redondeo)."""
    # Convertir frame a tiempo
    t_end = np.sqrt(2 * h0 / g) if h0 > 0 else 0.0
    t = (frame_idx / (frames - 1)) * t_end if frames > 1 else 0.0

    # Valores fÃ­sicos
    vi = 0.0  # Velocidad inicial asumida
    # PosiciÃ³n vertical (y)
    y = max(h0 - 0.5 * g * t ** 2, 0.0)
    v = vi + g * t

    # Calcular los tÃ©rminos de y = vi*t + 0.5*g*t^2 con precisiÃ³n completa
    term1 = vi * t
    term2 = 0.5 * g * (t ** 2)
    d = term1 + term2  # Desplazamiento calculado con precisiÃ³n

    # Mover cÃ­rculo (asegurando movimiento vertical)
    circle.center = (0.0, y)  # La coordenada x debe permanecer en 0.0 para caÃ­da vertical

    # Actualizar flecha
    start = (0.0, y - radius - 0.05)
    max_visual = max(0.28, h0 * 0.35)
    arrow_len = min(max_visual, 0.18 + 0.35 * (v / (np.sqrt(2 * g * h0) + 1e-9))) if h0 > 0 else 0.18
    end = (0.0, y - radius - 0.05 - arrow_len)
    try:
        arrow.set_positions(start, end)
    except Exception:
        try:
            arrow.remove()
        except Exception:
            pass
        arrow = patches.FancyArrowPatch(start, end, arrowstyle='->', mutation_scale=20, color='orange', linewidth=3, zorder=6)
        ax.add_patch(arrow)

    # Textos numÃ©ricos (truncados a 2 decimales sin redondeo)
    t_text.set_text(f"t = {trunc2(t)} s")
    v_text.set_text(f"v = {trunc2(v)} m/s")
    y_text.set_text(f"y = {trunc2(y)} m")

    # Mensajes dinÃ¡micos
    if t < 1e-6:
        phase_text.set_text("El objeto estÃ¡ suspendido en el aire. PrepÃ¡rate para soltarlo.")
        phase_text.set_color('blue')
    elif y > 1e-3:
        phase_text.set_text("La gravedad acelera el objeto: la velocidad aumenta con el tiempo.")
        phase_text.set_color('green')
    else:
        phase_text.set_text("Â¡La bola ha llegado al suelo! En ausencia de aire, cae con aceleraciÃ³n constante.")
        phase_text.set_color('red')

    try:
        fig.canvas.draw()
    except Exception:
        pass

    # FÃ³rmulas con sustituciÃ³n (valores truncados a 2 decimales sin redondeo)
    info_html = ""
    if show_formulas:
        # Calcular valores para mostrar (truncados)
        vi_s = trunc2(vi)
        g_s = trunc2(g)
        t_s = trunc2(t)
        term1_s = trunc2(term1)
        term2_s = trunc2(term2)
        d_s = trunc2(d)
        v_s = trunc2(v)
        # Mostrar paso a paso
        info_html = f"""
        <div style="font-family: sans-serif; font-size:14px; line-height:1.4">
          <b>FÃ³rmulas (sustituciÃ³n numÃ©rica â€” pasos):</b><br>
          <span style="color:blue">vf = vi + g t</span> â†’
             <span style="color:green">{vi_s} + {g_s}Â·({t_s}) = <b>{v_s} m/s</b></span><br>
          <span style="color:orange">y = viÂ·t + Â½Â·gÂ·tÂ²</span> â†’ <br>
             &nbsp;&nbsp;&nbsp;Sustituyendo: {vi_s}Â·{t_s} + 0.5Â·{g_s}Â·({t_s})Â²  <br>
             &nbsp;&nbsp;&nbsp;TÃ©rminos: {term1_s} + {term2_s}  <br>
             &nbsp;&nbsp;&nbsp;Suma: <b>{d_s} m</b><br>
          <span style="color:purple">t = (vf - vi)/g</span> â†’
             <span style="color:purple">({v_s} - {vi_s})/{g_s} = <b>{trunc2((v - vi) / g)} s</b></span>
        </div>
        """
    else:
        info_html = "<div style='color:gray'>FÃ³rmulas ocultas.</div>"

    return info_html

# -------------------------
# Widgets e interfaz
# -------------------------
altura_btns = widgets.ToggleButtons(
    options=[('1 m', 1.0), ('2 m', 2.0), ('5 m', 5.0), ('10 m', 10.0)],
    description='Altura:', value=5.0
)
masa_btns = widgets.ToggleButtons(
    options=[('0.5 kg', 0.5), ('1 kg', 1.0), ('2 kg', 2.0), ('5 kg', 5.0)],
    description='Masa:', value=1.0
)
show_formulas_cb = widgets.Checkbox(value=True, description='Mostrar fÃ³rmulas')
btn_soltar = widgets.Button(description='ğŸ’§ Soltar objeto', button_style='info')
btn_reiniciar = widgets.Button(description='â†º Reiniciar', button_style='warning', disabled=True)

frames = 200
slider = widgets.IntSlider(value=0, min=0, max=frames-1, step=1, description='Frame:', layout=widgets.Layout(width='60%'))
play = widgets.Play(value=0, min=0, max=frames-1, interval=30, description="Play", disabled=False)
widgets.jslink((play, 'value'), (slider, 'value'))

anim_out = widgets.Output()

# TÃ­tulo + introducciÃ³n
title_html = HTML("<h1 style='color:darkred;'>ğŸŒŸ SimulaciÃ³n Interactiva de CaÃ­da Libre sin Resistencia del Aire ğŸŒŸ</h1>")
intro_html = HTML("""
<p style='font-size:16px; text-align:center; margin-bottom:15px;'>
En esta simulaciÃ³n observarÃ¡s cÃ³mo una bola cae bajo la acciÃ³n de la gravedad, <b style='color:red;'>sin resistencia del aire</b>.
PodrÃ¡s variar la altura inicial y la masa de la bola, y ver cÃ³mo cambian la altura, la velocidad y el tiempo durante la caÃ­da.
La simulaciÃ³n muestra que, sin aire, la masa no afecta el tiempo de caÃ­da, y todos los objetos caen con la misma aceleraciÃ³n de 9.8 m/sÂ².
</p>
""")
seleccion_html = HTML("""
<p style='font-size:15px; color:darkblue; margin-top:15px;'>
Elige altura y masa (la masa no influye en vacÃ­o). Marca <b>Mostrar fÃ³rmulas</b> para ver los cÃ¡lculos. Pulsa <b>Soltar objeto</b> y luego â–¶ Play.
</p>
""")
importante_html = HTML("""
<h3 style='color:darkblue;'>ğŸ“Œ Conceptos clave de la caÃ­da libre</h3>
<p style='font-size:15px;'>
âœ”ï¸ La <b>aceleraciÃ³n gravitacional</b> de 9.8 m/sÂ², se considera positiva al descender el objeto y negativa al ascender el objeto.<br>
âœ”ï¸ La <b>velocidad final</b> aumenta con el tiempo (<b>vf = vi + gÂ·t</b>).<br>
âœ”ï¸ La <b>altura</b> o posiciÃ³n del objeto respecto al punto de referencia cambia segÃºn (<b>y = vi t + Â½ g tÂ²</b>).<br>
âœ”ï¸ El <b>tiempo</b> se puede obtener de la velocidad final (<b>t = (vf - vi)/g</b>).<br>
âœ”ï¸ Otras FÃ³rmulas y=( vi â€“ vf  /2) t  ;    2gh= vfÂ² â€“ viÂ².
</p>
""")

# Mostrar interfaz inicial
display(
    title_html,
    intro_html,
    seleccion_html,
    widgets.HBox([altura_btns, masa_btns, show_formulas_cb]),
    widgets.HBox([btn_soltar, btn_reiniciar]),
    HTML("<hr>"),
    importante_html,
    widgets.HBox([play, slider])
)

# -------------------------
# LÃ³gica de interacciÃ³n
# -------------------------
current_scene = {}

def on_soltar_clicked(b):
    h0 = float(altura_btns.value)
    show_form = bool(show_formulas_cb.value)

    fig, ax, circle, arrow, t_text, v_text, y_text, radius, phase_text, t_end = create_scene(h0)
    current_scene.update(dict(fig=fig, ax=ax, circle=circle, arrow=arrow, t_text=t_text, v_text=v_text, y_text=y_text, radius=radius, phase_text=phase_text, h0=h0, show_form=show_form))

    btn_reiniciar.disabled = False
    display(anim_out)

    def update(frame_idx):
        with anim_out:
            clear_output(wait=True)
            info_html = update_scene(frame_idx, fig, ax, circle, arrow, t_text, v_text, y_text, radius, phase_text, h0, show_form, frames=frames)
            display(fig)
            display(HTML(info_html))

    # Asegurar que el slider actualice la escena
    def handler(change):
        update(change['new'])
    slider.observe(handler, names='value')

    update(0)

btn_soltar.on_click(on_soltar_clicked)

def on_reiniciar_clicked(b):
    with anim_out:
        clear_output(wait=True)
    play.value = 0
    slider.value = 0
    btn_reiniciar.disabled = True
    if current_scene.get('fig'):
        plt.close(current_scene['fig'])
    current_scene.clear()
    display(HTML("<p style='color:darkblue; background-color:lightyellow; padding:10px;'><b>Â¡SimulaciÃ³n reiniciada! Selecciona una nueva altura y pulsa 'Soltar objeto'.</b></p>"))

btn_reiniciar.on_click(on_reiniciar_clicked)
